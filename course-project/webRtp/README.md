# WebRtp

Проект реализует систему обзвона абонентов, подключенных к виртуальной АТС с возможностью передачи голосовых сообщений.
В работе также предусмотрено REST API для обработки стандартных запросов от webRtp(101) абонента.

###  REST API
Реализована обработка запросов соответствующая подходу REST.
Обработка разделена на 4 модуля-хэндлера, каждый из которых обрабатывает запросы для отдельной сущности.
Тестирование запросов осуществляется в Postman.

*__Handlers:__*
* *abonent_h.erl* - Обработка запросов относительно одного абонента, используя API *__"webRtp_mnesia.erl"__*.
* *abonents_h.erl* - Обработка запроса GET относительно всех абонентов, также API Mnesia.
* *call_abonent_h.erl* - Обработка GET запроса звонка конкретному абоненту по номеру, используется API *__"webRtp_nksip.erl"__* и *__"webRtp_mnesia.erl"__*.
* *broadcast_h.erl* - Обработка GET запроса для "broadcast call" всем абонентам из БД, используется API *__"webRtp_nksip.erl"__* и *__"webRtp_mnesia.erl"__*.

Для разделения логики используются разные маршруты сущностей.

*__Routes:__*
```erlang
{"/abonent/[:number]"},
{"/abonents"}, 
{"/call/abonent/[:number]"]}, 
{"/call/broadcast"}
```
*__Examples of requests from the client:__*
```
GET /abonent/[:number] - Возвращает Num и Name конкретного Абонента по номеру из БД.
DELETE /abonent/[:number] - Удаляет Абонента по номеру из БД.
POST /abonent - Добавляет запись об абоненте в БД используя Body из Requst`a.
GET /abonents - Возвращает список всех добавленных абонентов.
GET /call/abonent/[:number] - Производит звонок определенного абонента по номеру.
GET /call/broadcast - Совершает обзвон всех абонентов находящихся в БД по очереди и возвращает результат обзвона
```
### База Данных
Для работы с необъемными данными абонента был выбран внутренний инструмент Erlang - Mnesia.
Модуль *__"webRtp_mnesia.erl"__* реализует API функции для стандартных действий в БД ***(чтение/запись/удаление/обновление данных& etc.)*** с абонентом, используя чистые операции и транзакции. 
Для отладки и демонстрации предусмотрен вывод логов уровня NOTICE/WARNING в главную консоль запущенного приложения с использованием kernel\Logger.

*__API функции:__*
* start/0 - Запуск службы
* stop/0 - Завершает работу службы.
* insert_abonent/2 - Добавляет абонента в БД, используя в аргументах Num и Name.
* delete_abonent/1 - Удаляет абонента из БД по Num.
* get_abonent/1, - Возвращает запись об абоненте из таблицы ({Num, Name}).
* get_all_abonents/0 - Возвращает список всех абонентов добавленных в БД.

### Сигнализация звонка 
Сигнализация в звонке, или же обработка запросов протокола SIP с использованием прикладных 
протоколов SDP(Session Description Protocol - для обмена данными о Request) 
и RTP(Real-time Transport Protocol для обеспечения голосовой связи)
Для этого в модуле *__"webRtp_nksip.erl"__* существует API для обработки некоторых SIP Request.

Реализованы следующие API функции:
* start/0 - Запускает службу nksip при старте приложения.
* register/1 - Регистрирует абонента по номеру.
* call_abonent/1 - Совершает звонок абоненту по номеру.

*Используемые API функции из nksip: 
* nksip:start_link/2 - Запускает SIP-server;
* nksip_uac:register/3 - Регистрирует пользователя на SIP-server;
* nksip_uac:invite/3 - Отправляет запрос на установление диалога другому абоненту;
* nksip_dialog:get_meta/2 - Используется для получения мета-информации о SIP диалоге;
* nksip_uac:bye/2 - Отправляет запрос на завершение диалога-сессии.

### Docker
В проекте реализован Docker контейнер с необходимыми инструкциями
для создания образа в контексте которого работает приложение.

Для того, чтобы _**запустить**_ проект, необходимо выполнить команду:
```erlang
docker build -t webrtp .
docker run -p 8080:8080 webrtp 

```
### *Примечания
* Приложение регистрируется как 101 абонент и совершает вызовы на другие абоненты, которых предоставляет АТС c ECSS10. 
